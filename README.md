# osb-resequencer-console
The osb-resequencer-console is a Spring Boot application pacakaged as a war file that can be deployed in weblogic that contains spring batch jobs for automatic retrying of failed OSB sequencer messages.

## Local Weblogic Domain

### Pre Requisites

Building a local weblogic domain requires that Oracle XE has been installed and that the OSEF_SOAINFRA schema already exist in the database. 

### Building the Domain

A local weblogic domain that can be used for debug and testing purposes can be generated by running the following command...

```bash
$ mvn -P weblogic-domain install
```
This maven build will do the following
- Creates a `seq_retry_processor` schema in a local oracle xe database.  It will drop the schema and re-create it if it already exists.
- Creates a basic weblogic domain in the `base_domain` folder using the  [domain.yml](config/domain.yml) template file which configures the following datasources required for deploying the application:-
    * **wls.db.SeqRetryProcessor** - This datasource contains the spring batch and application tables.  The schema objects are created by liquibase using the [seq-retry-processor-changelog.xml](src/main/resources/META-INF/liquibase/seq-retry-processor-changelog.xml) changelog file.  This uses the `seq_retry_processor` schema that is created in the previous step.
    * **jdbc/SOADataSource** - This is an Oracle Service Bus schema created by the Oracle `repository creation utility (rcu)` program.  This schema has tables that contain the sequencer messages and state.


## Spring Batch Jobs
The sequence retry processor application contains the following batch jobs:-

1. ### Retry Job
   The Retry Job monitors Oracle Resequencer tables 'OSB_GROUP_STATUS' and 'OSB_RESEQUENCER_MESSAGE' these tables live in SOA_INFRA Schema created by RCU when installing Oracle Service Bus.

2. ### Purge Job
   The Purge Job clears retry messages for successful or aborted messages
   
3. ### PurgeOsbResequencer
   This purges aborted or completed osb resequencer messages and empty groups
   
4. ### PurgeSpringBatch
   This purges the spring batch tables of job executions older than 7 days

## Deployment
Following are the checklist items for deployment.


### Configuration File
Configuration file with the name “osb-resequencer-console.yml“ should be placed in $DOMAIN_HOME/config/osb-resequencer-console. This can be copied from source code where its placed at osb-resequencer-console/src/main/resources/application.yml. please note when placing in config/osb-resequencer-console please rename it to “osb-resequencer-console.yml”.  The contents of this file should look similar to this...

```
# ===================================================================
# Application specific properties
# ===================================================================
datasources:
  retry-processor-datasource-jndi-name: wls.db.SeqRetryProcessor
  soa-infra-datasource-jndi-name: jdbc.SOADataSource

application:
  environment: LOCAL
  navbar-background-color: '#abd4de'
  retryJobSchedule: 0 0/1 * * * ?
  purgeJobSchedule: 0 0/30 * * * ?
  purgeOsbResequencerJobSchedule: 0 0 1 * * ?
  purgeSpringBatchJobSchedule: 0 30 0 * * ?  
  defaults:
    retriesEnabled: true
    retries: 5
    delay: 120
    delayFactor: 3
```

### DataSources
Since this is a Spring Batch application running on Oracle Database, this needs following datasources:
1. Datasource for OSB SOA_INFRA DB: datasource with JNDI name “jdbc.SOADataSource” for OSB SOA_INFRA database.
2. Datasource for the OSB_RETRY_MESSAGE table: datasource with JNDI name: wls.db.SeqRetryProcessor

	
Note: These JNDI names are configurable in the osb-resequencer-console.yml configuration file.

### SPRING BATCH TABLES
The spring batch tables will be created automatically in the seqretryprocessor schema on first run using the connection wls.db.SeqRetryProcessor

### OSB_RETRY_MESSAGE Table
The 'OSB_RETRY_MESSAGE' table is required by retry processor to keep track of retry attempts on a message.
The application will create this table on initialisation using the wls.db.SeqRetryProcessor datasource which needs to already exist

## WAR Deployment
Once all above pre-requisites are done, execute 'mvn clean install' on project root, it will produce WAR file in target directory where it can be deployed into Weblogic Server.

## Log File
Once deployed, log file will be crated in DOMAIN_HOME/log folder with name 'osb-resequencer-console.log'.
It's all configurable in 'src/main/resources/logback-spring.xml' file.




